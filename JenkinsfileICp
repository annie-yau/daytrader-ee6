pipeline {
    agent any
    parameters {
        string(name: 'ICP_MASTER_CFC', defaultValue: 'mycluster.icp:8500')
        string(name: 'ICP_MASTER_USER', defaultValue: 'technet')
        string(name: 'ICP_MASTER_PW', defaultValue: '1234qweR')
        string(name: 'ICP_MASTER_8001', defaultValue: 'https://161.202.60.33:8001')
        string(name: 'ICP_TOKEN', defaultValue: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdF9oYXNoIjoiOTJkMWQzYWY1MjA3N2FiNjE4ODFkOTM3YThjMWEyMzYwMTZmMGQ1MyIsInJlYWxtTmFtZSI6ImN1c3RvbVJlYWxtIiwidW5pcXVlU2VjdXJpdHlOYW1lIjoidGVjaG5ldCIsImlzcyI6Imh0dHBzOi8vbXljbHVzdGVyLmljcDo5NDQzL29pZGMvZW5kcG9pbnQvT1AiLCJhdWQiOiIwNzY0ZmNmZmU1MTQyNjU4N2JmNGI5NDAyOTE4M2VlYSIsImV4cCI6MTU1MDU2NzM5NCwiaWF0IjoxNTUwNTM4NTk0LCJzdWIiOiJ0ZWNobmV0IiwidGVhbVJvbGVNYXBwaW5ncyI6WyJzeXN0ZW06bWFzdGVycyJdfQ.UrCFA-43d7MXrHDofDApNiubnERzPN0iEFTedv48oi-YF0VpaxHHcw6Gfk31BcwEhtfIPoGQQGX_N1ibdWq3nawfLGC7_aaIIyfl19kThooC6Ctp_JyEhqGaSPHTBP8bCzPE8Gws79AVhMDuwtb-D_QEqAOFyfF5v5rPKIdOxqK_NgXEOlq7d79peXIjM9PKp8r-d9FHeNGPz7mRydgCJrjSA6bULpkg-DsRoa1DnOiQElZDotrLnJmzdipjaWDcpnE1tmy15rNTqnm7G_-WZo_nDSqTM_xk3N6CPqqkkWjCqR3YE7tGvsXgZcjpuA8F4Hsw2FEgPtBQzaljSjES1w')
    }
    
    triggers {
        GenericTrigger (
            token:'daytrader',
            printContributedVariables: false,
            printPostContent: false,
            silentResponse: false
        )
     }
     
    stages {
        stage('Continuous Integration') {
            steps {
                sh '''
                   cd dt-ejb
                   mvn clean install
                   cd ../Rest
                   mvn clean install
                   cd ../web
                   mvn clean install
                   cd ../daytrader-ee6
                   mvn clean verify -Pci-docker
                   cd ..
                   '''
             }             
        }
        stage('Continuous Delivery') {
            steps {
                sh '''     
                    export PATH=$PATH:/usr/local/bin
                    echo "docker login to mycluster.icp"
                    docker login -u $ICP_MASTER_USER -p $ICP_MASTER_PW $ICP_MASTER_CFC
                    echo "docker tag"
                    docker tag dhvines/daytrader-ee6:1.0-snapshot $ICP_MASTER_CFC/workshop/daytrader-ee6
                    echo "docker push"
                    docker push $ICP_MASTER_CFC/workshop/daytrader-ee6
                    echo "kubectl login"                    
                    kubectl config set-cluster mycluster --server=$ICP_MASTER_8001 --insecure-skip-tls-verify=true
                    kubectl config set-context mycluster-context --cluster=mycluster
                    kubectl config set-credentials $ICP_MASTER_USER --token=$ICP_TOKEN
                    kubectl config set-context mycluster-context --user=$ICP_MASTER_USER --namespace=workshop
                    kubectl config use-context mycluster-context
                    #!/bin/bash
                    echo "checking if wlp-daytrader-jenkins already exists"
                    if kubectl describe service wlp-daytrader-jenkins -n workshop; then
                        echo "Service already exists, delete first"
                        kubectl delete service wlp-daytrader-jenkins -n workshop
                    fi
                    if kubectl describe deployment wlp-daytrader-jenkins -n workshop; then
                        echo "Application already exists, delete first"
                        kubectl delete deployment wlp-daytrader-jenkins -n workshop
                    fi
                    echo "Create application"
                    kubectl create -f app.json
                    echo "Create service"
                    set +e
                    kubectl create -f service.json                                      
                    echo "finished"
                '''
            }
        }
    }
}
