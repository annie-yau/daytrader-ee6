pipeline {
    agent any
    parameters {
        string(name: 'ICP_MASTER_CFC', defaultValue: 'mycluster.icp:8500')
        string(name: 'ICP_MASTER_8001', defaultValue: 'http://161.202.60.34:31885')
        string(name: 'ICP_TOKEN', defaultValue: '=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdF9oYXNoIjoiYmE3YjljZDNmMWRhNDY0Y2E5NmZkMzdhMDc1M2Q1YmZjMmYyNDQwNiIsInJlYWxtTmFtZSI6ImN1c3RvbVJlYWxtIiwidW5pcXVlU2VjdXJpdHlOYW1lIjoiYWRtaW4iLCJpc3MiOiJodHRwczovL215Y2x1c3Rlci5pY3A6OTQ0My9vaWRjL2VuZHBvaW50L09QIiwiYXVkIjoiMDc2NGZjZmZlNTE0MjY1ODdiZjRiOTQwMjkxODNlZWEiLCJleHAiOjE1NTAyNDk5NDUsImlhdCI6MTU1MDIyMTE0NSwic3ViIjoiYWRtaW4iLCJ0ZWFtUm9sZU1hcHBpbmdzIjpbXX0.Q7KBdVIDcqS2TA-JVlytblJ6RKo5R-dp_Sv9SeyRA6jQ8XsWQTgLOoN1LmYtpn1w6Hi_MRm3Xz5PSWB0sOvYAt_jOFoKc-sbP73CljRYKUVWx-cAzbXhexVVhc5nhdRwGVbhFFy2hzBUjLmrPq352nuFBaIpXuL2726_rKqac9wsM3ilgUb3aX52OsiNMUoYQQS7M1ArFR3pImp_pWqdNqgqivBnv4-2KoGGp8Xa6svs2Ingcm1TpUM7-uFOyVDQ4gNPTodUaIp-F6O0V1dI9VD8OGlVrMzscb8RnfBfi1QXweG7ljg2MmBrWTxNBp0Ql8Oc8U5TjuDpAgE_jJagIQ')
    }
    stages {
        stage('Continuous Integration') {
            steps {
                sh '''
                    export M2_HOME=/usr/local/src/apache-maven
                    export PATH=$PATH:$M2_HOME/bin
                    export JAVA_HOME=/opt/jdk1.8.0_171
                   cd dt-ejb
                   mvn clean install
                   cd ../Rest
                   mvn clean install
                   cd ../web
                   mvn clean install
                   cd ../daytrader-ee6
                   mvn clean verify -Pci-docker
                   cd ..
                   '''
             }             
        }
        stage('Continuous Delivery') {
            steps {
                sh '''     
                    export PATH=$PATH:/usr/local/bin
                    echo "docker login to master.cfc"
                    docker login -u admin -p admin $ICP_MASTER_CFC
                    echo "docker tag"
                    docker tag dhvines/daytrader-ee6:1.0-SNAPSHOT $ICP_MASTER_CFC/default/daytrader-ee6
                    echo "docker push"
                    docker push $ICP_MASTER_CFC/default/daytrader-ee6
                    echo "kubectl login"                    
                    kubectl config set-cluster cfc --server=$ICP_MASTER_8001 --insecure-skip-tls-verify=true
                    kubectl config set-context cfc --cluster=cfc
                    kubectl config set-credentials user --token=$ICP_TOKEN
                    kubectl config set-context cfc --user=user --namespace=default
                    kubectl config use-context cfc
                    #!/bin/bash
                    echo "checking if wlp-daytrader-jenkins already exists"
                    if kubectl describe service wlp-daytrader-jenkins; then
                        echo "Service already exists, delete first"
                        kubectl delete service wlp-daytrader-jenkins
                    fi
                    if kubectl describe deployment wlp-daytrader-jenkins; then
                        echo "Application already exists, delete first"
                        kubectl delete deployment wlp-daytrader-jenkins
                    fi
                    echo "Create application"
                    kubectl create -f app.json
                    echo "Create service"
                    set +e
                    kubectl create -f service.json                                      
                    echo "finished"
                '''
            }
        }
    }
}
